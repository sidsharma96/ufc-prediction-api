"""initial_schema

Revision ID: 221dd94ffc22
Revises: 
Create Date: 2026-01-11 01:42:21.468628+00:00

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = '221dd94ffc22'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade database schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('data_imports',
    sa.Column('source', sa.String(length=50), nullable=False, comment='Data source (kaggle, espn, ufc_scraper)'),
    sa.Column('import_type', sa.String(length=50), nullable=False, comment='Import type (full, incremental, event_update)'),
    sa.Column('status', sa.String(length=20), nullable=False, comment='pending, running, completed, failed'),
    sa.Column('records_processed', sa.Integer(), nullable=False),
    sa.Column('records_created', sa.Integer(), nullable=False),
    sa.Column('records_updated', sa.Integer(), nullable=False),
    sa.Column('records_failed', sa.Integer(), nullable=False),
    sa.Column('errors', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='List of errors encountered during import'),
    sa.Column('metadata_json', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Additional import metadata'),
    sa.Column('started_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('id', sa.UUID(), server_default=sa.text('gen_random_uuid()'), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_imports_source_started', 'data_imports', ['source', 'started_at'], unique=False)
    op.create_index('idx_imports_status', 'data_imports', ['status'], unique=False)
    op.create_table('events',
    sa.Column('ufc_id', sa.String(length=100), nullable=True, comment='UFC event identifier'),
    sa.Column('espn_id', sa.String(length=100), nullable=True, comment='ESPN event ID'),
    sa.Column('name', sa.String(length=200), nullable=False, comment="Full event name (e.g., 'UFC 300: Pereira vs. Hill')"),
    sa.Column('short_name', sa.String(length=100), nullable=True, comment="Short name (e.g., 'UFC 300')"),
    sa.Column('event_type', sa.String(length=50), nullable=True, comment='numbered, fight_night, apex, etc.'),
    sa.Column('date', sa.Date(), nullable=False),
    sa.Column('start_time', sa.DateTime(timezone=True), nullable=True, comment='Event start time with timezone'),
    sa.Column('venue', sa.String(length=200), nullable=True),
    sa.Column('city', sa.String(length=100), nullable=True),
    sa.Column('state', sa.String(length=100), nullable=True),
    sa.Column('country', sa.String(length=100), nullable=True),
    sa.Column('is_completed', sa.Boolean(), nullable=False),
    sa.Column('is_cancelled', sa.Boolean(), nullable=False),
    sa.Column('poster_url', sa.Text(), nullable=True),
    sa.Column('id', sa.UUID(), server_default=sa.text('gen_random_uuid()'), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('espn_id')
    )
    op.create_index('idx_events_date_completed', 'events', ['date', 'is_completed'], unique=False)
    op.create_index('idx_events_type_date', 'events', ['event_type', 'date'], unique=False)
    op.create_index(op.f('ix_events_date'), 'events', ['date'], unique=False)
    op.create_index(op.f('ix_events_is_completed'), 'events', ['is_completed'], unique=False)
    op.create_index(op.f('ix_events_ufc_id'), 'events', ['ufc_id'], unique=True)
    op.create_table('fighters',
    sa.Column('ufc_id', sa.String(length=100), nullable=True, comment="UFC athlete page slug (e.g., 'conor-mcgregor')"),
    sa.Column('espn_id', sa.String(length=100), nullable=True, comment='ESPN fighter ID'),
    sa.Column('first_name', sa.String(length=100), nullable=False),
    sa.Column('last_name', sa.String(length=100), nullable=False),
    sa.Column('nickname', sa.String(length=100), nullable=True),
    sa.Column('date_of_birth', sa.Date(), nullable=True),
    sa.Column('nationality', sa.String(length=100), nullable=True),
    sa.Column('hometown', sa.String(length=200), nullable=True),
    sa.Column('height_cm', sa.Float(), nullable=True, comment='Height in centimeters'),
    sa.Column('weight_kg', sa.Float(), nullable=True, comment='Weight in kilograms'),
    sa.Column('reach_cm', sa.Float(), nullable=True, comment='Reach in centimeters'),
    sa.Column('leg_reach_cm', sa.Float(), nullable=True, comment='Leg reach in centimeters'),
    sa.Column('weight_class', sa.String(length=50), nullable=True, comment='Primary weight class'),
    sa.Column('stance', sa.String(length=20), nullable=True, comment='Orthodox, Southpaw, or Switch'),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('ufc_profile_url', sa.Text(), nullable=True),
    sa.Column('image_url', sa.Text(), nullable=True),
    sa.Column('id', sa.UUID(), server_default=sa.text('gen_random_uuid()'), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('espn_id')
    )
    op.create_index('idx_fighters_name', 'fighters', ['last_name', 'first_name'], unique=False)
    op.create_index('idx_fighters_weight_class_active', 'fighters', ['weight_class', 'is_active'], unique=False)
    op.create_index(op.f('ix_fighters_ufc_id'), 'fighters', ['ufc_id'], unique=True)
    op.create_index(op.f('ix_fighters_weight_class'), 'fighters', ['weight_class'], unique=False)
    op.create_table('fights',
    sa.Column('event_id', sa.UUID(), nullable=False),
    sa.Column('fighter1_id', sa.UUID(), nullable=False),
    sa.Column('fighter2_id', sa.UUID(), nullable=False),
    sa.Column('weight_class', sa.String(length=50), nullable=False),
    sa.Column('is_title_fight', sa.Boolean(), nullable=False),
    sa.Column('is_main_event', sa.Boolean(), nullable=False),
    sa.Column('is_co_main_event', sa.Boolean(), nullable=False),
    sa.Column('scheduled_rounds', sa.Integer(), nullable=False),
    sa.Column('fight_order', sa.Integer(), nullable=True, comment='Position on card (1 = main event)'),
    sa.Column('winner_id', sa.UUID(), nullable=True),
    sa.Column('result_method', sa.String(length=100), nullable=True, comment='KO/TKO, Submission, Decision (Unanimous/Split/Majority)'),
    sa.Column('result_method_detail', sa.String(length=200), nullable=True, comment="Specific method (e.g., 'Rear Naked Choke', 'Head Kick')"),
    sa.Column('ending_round', sa.Integer(), nullable=True),
    sa.Column('ending_time', sa.String(length=10), nullable=True, comment="Time in round (e.g., '4:32')"),
    sa.Column('is_no_contest', sa.Boolean(), nullable=False),
    sa.Column('is_draw', sa.Boolean(), nullable=False),
    sa.Column('status', sa.String(length=20), nullable=False, comment='scheduled, live, completed, cancelled'),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('id', sa.UUID(), server_default=sa.text('gen_random_uuid()'), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint('fighter1_id != fighter2_id', name='different_fighters'),
    sa.ForeignKeyConstraint(['event_id'], ['events.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['fighter1_id'], ['fighters.id'], ),
    sa.ForeignKeyConstraint(['fighter2_id'], ['fighters.id'], ),
    sa.ForeignKeyConstraint(['winner_id'], ['fighters.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_fights_event_order', 'fights', ['event_id', 'fight_order'], unique=False)
    op.create_index('idx_fights_status_date', 'fights', ['status'], unique=False)
    op.create_index(op.f('ix_fights_event_id'), 'fights', ['event_id'], unique=False)
    op.create_index(op.f('ix_fights_fighter1_id'), 'fights', ['fighter1_id'], unique=False)
    op.create_index(op.f('ix_fights_fighter2_id'), 'fights', ['fighter2_id'], unique=False)
    op.create_index(op.f('ix_fights_status'), 'fights', ['status'], unique=False)
    op.create_index(op.f('ix_fights_weight_class'), 'fights', ['weight_class'], unique=False)
    op.create_table('fighter_snapshots',
    sa.Column('fighter_id', sa.UUID(), nullable=False),
    sa.Column('fight_id', sa.UUID(), nullable=False),
    sa.Column('snapshot_date', sa.Date(), nullable=False),
    sa.Column('wins', sa.Integer(), nullable=False),
    sa.Column('losses', sa.Integer(), nullable=False),
    sa.Column('draws', sa.Integer(), nullable=False),
    sa.Column('no_contests', sa.Integer(), nullable=False),
    sa.Column('striking_accuracy', sa.Numeric(precision=5, scale=2), nullable=True, comment='Striking accuracy percentage (0-100)'),
    sa.Column('strikes_landed_per_min', sa.Numeric(precision=5, scale=2), nullable=True, comment='Significant strikes landed per minute'),
    sa.Column('strikes_absorbed_per_min', sa.Numeric(precision=5, scale=2), nullable=True, comment='Significant strikes absorbed per minute'),
    sa.Column('strike_defense', sa.Numeric(precision=5, scale=2), nullable=True, comment='Strike defense percentage (0-100)'),
    sa.Column('takedown_accuracy', sa.Numeric(precision=5, scale=2), nullable=True, comment='Takedown accuracy percentage (0-100)'),
    sa.Column('takedown_avg_per_15min', sa.Numeric(precision=5, scale=2), nullable=True, comment='Takedowns averaged per 15 minutes'),
    sa.Column('takedown_defense', sa.Numeric(precision=5, scale=2), nullable=True, comment='Takedown defense percentage (0-100)'),
    sa.Column('submission_avg_per_15min', sa.Numeric(precision=5, scale=2), nullable=True, comment='Submissions averaged per 15 minutes'),
    sa.Column('weight_at_fight_kg', sa.Numeric(precision=5, scale=2), nullable=True, comment='Weight at weigh-in in kg'),
    sa.Column('win_percentage', sa.Numeric(precision=5, scale=2), nullable=True, comment='Win percentage (0-100)'),
    sa.Column('finish_rate', sa.Numeric(precision=5, scale=2), nullable=True, comment='Percentage of wins by finish (0-100)'),
    sa.Column('ko_rate', sa.Numeric(precision=5, scale=2), nullable=True, comment='Percentage of wins by KO/TKO (0-100)'),
    sa.Column('submission_rate', sa.Numeric(precision=5, scale=2), nullable=True, comment='Percentage of wins by submission (0-100)'),
    sa.Column('avg_fight_time_seconds', sa.Integer(), nullable=True, comment='Average fight duration in seconds'),
    sa.Column('recent_form', sa.String(length=20), nullable=True, comment="Last 5 fights as string (e.g., 'WWLWW')"),
    sa.Column('win_streak', sa.Integer(), nullable=False),
    sa.Column('loss_streak', sa.Integer(), nullable=False),
    sa.Column('days_since_last_fight', sa.Integer(), nullable=True),
    sa.Column('id', sa.UUID(), server_default=sa.text('gen_random_uuid()'), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['fight_id'], ['fights.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['fighter_id'], ['fighters.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('fighter_id', 'fight_id', name='uq_fighter_fight_snapshot')
    )
    op.create_index('idx_snapshots_fighter_date', 'fighter_snapshots', ['fighter_id', 'snapshot_date'], unique=False)
    op.create_index(op.f('ix_fighter_snapshots_fight_id'), 'fighter_snapshots', ['fight_id'], unique=False)
    op.create_index(op.f('ix_fighter_snapshots_fighter_id'), 'fighter_snapshots', ['fighter_id'], unique=False)
    op.create_index(op.f('ix_fighter_snapshots_snapshot_date'), 'fighter_snapshots', ['snapshot_date'], unique=False)
    op.create_table('system_predictions',
    sa.Column('fight_id', sa.UUID(), nullable=False),
    sa.Column('predicted_winner_id', sa.UUID(), nullable=False),
    sa.Column('confidence', sa.Numeric(precision=5, scale=2), nullable=False, comment='Prediction confidence 0-100'),
    sa.Column('fighter1_win_probability', sa.Numeric(precision=5, scale=4), nullable=True, comment='Probability fighter1 wins (0-1)'),
    sa.Column('fighter2_win_probability', sa.Numeric(precision=5, scale=4), nullable=True, comment='Probability fighter2 wins (0-1)'),
    sa.Column('ko_probability', sa.Numeric(precision=5, scale=4), nullable=True, comment='Probability of KO/TKO finish'),
    sa.Column('submission_probability', sa.Numeric(precision=5, scale=4), nullable=True, comment='Probability of submission finish'),
    sa.Column('decision_probability', sa.Numeric(precision=5, scale=4), nullable=True, comment='Probability of decision'),
    sa.Column('algorithm_version', sa.String(length=20), nullable=False, comment="Version of prediction algorithm (e.g., 'rule_v1', 'ml_v2')"),
    sa.Column('feature_weights', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Weights used for this prediction'),
    sa.Column('feature_values', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='Feature values used for debugging and analysis'),
    sa.Column('is_correct', sa.Boolean(), nullable=True),
    sa.Column('id', sa.UUID(), server_default=sa.text('gen_random_uuid()'), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['fight_id'], ['fights.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['predicted_winner_id'], ['fighters.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('fight_id', 'algorithm_version', name='uq_fight_algorithm_prediction')
    )
    op.create_index('idx_system_predictions_accuracy', 'system_predictions', ['is_correct'], unique=False, postgresql_where='is_correct IS NOT NULL')
    op.create_index(op.f('ix_system_predictions_fight_id'), 'system_predictions', ['fight_id'], unique=False)
    op.create_index(op.f('ix_system_predictions_is_correct'), 'system_predictions', ['is_correct'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade database schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_system_predictions_is_correct'), table_name='system_predictions')
    op.drop_index(op.f('ix_system_predictions_fight_id'), table_name='system_predictions')
    op.drop_index('idx_system_predictions_accuracy', table_name='system_predictions', postgresql_where='is_correct IS NOT NULL')
    op.drop_table('system_predictions')
    op.drop_index(op.f('ix_fighter_snapshots_snapshot_date'), table_name='fighter_snapshots')
    op.drop_index(op.f('ix_fighter_snapshots_fighter_id'), table_name='fighter_snapshots')
    op.drop_index(op.f('ix_fighter_snapshots_fight_id'), table_name='fighter_snapshots')
    op.drop_index('idx_snapshots_fighter_date', table_name='fighter_snapshots')
    op.drop_table('fighter_snapshots')
    op.drop_index(op.f('ix_fights_weight_class'), table_name='fights')
    op.drop_index(op.f('ix_fights_status'), table_name='fights')
    op.drop_index(op.f('ix_fights_fighter2_id'), table_name='fights')
    op.drop_index(op.f('ix_fights_fighter1_id'), table_name='fights')
    op.drop_index(op.f('ix_fights_event_id'), table_name='fights')
    op.drop_index('idx_fights_status_date', table_name='fights')
    op.drop_index('idx_fights_event_order', table_name='fights')
    op.drop_table('fights')
    op.drop_index(op.f('ix_fighters_weight_class'), table_name='fighters')
    op.drop_index(op.f('ix_fighters_ufc_id'), table_name='fighters')
    op.drop_index('idx_fighters_weight_class_active', table_name='fighters')
    op.drop_index('idx_fighters_name', table_name='fighters')
    op.drop_table('fighters')
    op.drop_index(op.f('ix_events_ufc_id'), table_name='events')
    op.drop_index(op.f('ix_events_is_completed'), table_name='events')
    op.drop_index(op.f('ix_events_date'), table_name='events')
    op.drop_index('idx_events_type_date', table_name='events')
    op.drop_index('idx_events_date_completed', table_name='events')
    op.drop_table('events')
    op.drop_index('idx_imports_status', table_name='data_imports')
    op.drop_index('idx_imports_source_started', table_name='data_imports')
    op.drop_table('data_imports')
    # ### end Alembic commands ###
